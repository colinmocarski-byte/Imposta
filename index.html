<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Whosus? – Impostor (Flip-Reveal)</title>
<style>
  :root{--bg:#0f172a;--card:#0b1222;--ink:#e5e7eb;--mut:#9ca3af;--acc:#22c55e;--bad:#ef4444}
  *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Inter,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#0b1022,#0f172a 45%,#0a1024);color:var(--ink)}
  .wrap{max-width:980px;margin:auto;padding:18px}
  h1{font-size:22px;margin:0 0 8px} h2{margin:0 0 10px}
  .card{background:var(--card);border:1px solid #1f2937;border-radius:14px;padding:14px;margin:12px 0;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
  .pill{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #1f2937;background:#0e1630;color:var(--ink)}
  .muted{color:var(--mut)} .small{font-size:12px}
  input,select,textarea{background:#0a142e;border:1px solid #1f2937;border-radius:10px;padding:10px;color:var(--ink);width:100%}
  button{appearance:none;background:#0a142e;border:1px solid #1f2937;color:var(--ink);padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700}
  button:hover{border-color:#334155} .primary{background:var(--acc);border-color:#16a34a;color:#07101f}
  .big{font-size:22px}
  .name{padding:8px 10px;border:1px dashed #334155;border-radius:10px;background:#0e1630}
  .vote-btn{display:block;width:100%;text-align:left;margin:6px 0;padding:10px 12px;border-radius:10px;border:1px solid #1f2937;background:#0e1630;cursor:pointer}
  .vote-btn.sel{border-color:var(--acc)}
  .timer{height:10px;background:#0a142e;border:1px solid #1f2937;border-radius:999px;overflow:hidden}
  .timer>div{height:100%;background:var(--acc);width:100%;transition:width .2s linear}

  /* Flip Card Animation */
  .flip-wrap{perspective:1200px; display:flex; justify-content:center; align-items:center; min-height:260px; margin-top:8px}
  .flip-card{position:relative; width:320px; max-width:90vw; height:190px; transform-style:preserve-3d; transition:transform .6s cubic-bezier(.2,.8,.2,1); cursor:pointer}
  .flip-card.flipped{transform:rotateY(180deg)}
  .face{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; padding:18px; border-radius:16px; border:1px solid #1f2937}
  .front{background:linear-gradient(160deg,#0e1630,#0a1427)}
  .back{background:linear-gradient(160deg,#11203e,#0c1832); transform:rotateY(180deg); backface-visibility:hidden}
  .front,.back{backface-visibility:hidden}
  .front .title{font-size:13px; color:#9ca3af; margin-bottom:6px}
  .front .who{font-size:22px; font-weight:800}
  .back .word{font-size:22px; font-weight:800; text-align:center; line-height:1.2}
  .back .role{font-size:13px; color:#9ca3af; margin-top:6px}
</style>
</head>
<body>
<div class="wrap">
  <header class="row" style="justify-content:space-between">
    <div>
      <h1>Whosus? – Impostor</h1>
      <div class="row"><span class="pill">Offline • Pass-&-Play</span><span class="pill">Flip-Reveal</span><span class="pill">Troll-Modus</span></div>
    </div>
    <button class="pill" onclick="showHelp()">Regeln</button>
  </header>

  <!-- Setup -->
  <div id="screen-setup" class="card">
    <h2>Spiel vorbereiten</h2>
    <div class="grid">
      <div class="card">
        <h3>Spieler:innen</h3>
        <div class="row">
          <input id="name-in" placeholder="Name eingeben & hinzufügen" onkeydown="if(event.key==='Enter') addPlayer()"/>
          <button class="primary" onclick="addPlayer()">Hinzufügen</button>
          <button onclick="quickFill()">Schnelles Füllen</button>
        </div>
        <div id="names" class="row"></div>
      </div>

      <div class="card">
        <h3>Einstellungen</h3>
        <div class="row" style="width:100%">
          <label class="pill">Rundendauer</label>
          <select id="dur"><option>60</option><option selected>90</option><option>120</option></select>
          <label class="pill">Impostors</label>
          <select id="impc"><option selected>1</option><option>2</option></select>
          <label class="pill"># Kategorien</label>
          <select id="kcount"></select>
        </div>
      </div>

      <div class="card">
        <h3>Kategorien</h3>
        <div id="cat-list" class="grid"></div>
        <div class="small muted">Beim Start werden keine Kategorie-Infos geleakt.</div>
      </div>

      <div class="card">
        <h3>Troll-Modus (Fun)</h3>
        <div class="row" style="width:100%">
          <label class="pill"><input type="checkbox" id="trollOn"> Aktiv</label>
          <label class="pill">Chaos: <span id="chaosVal">20%</span></label>
          <input type="range" id="chaos" min="0" max="100" value="20" oninput="document.getElementById('chaosVal').textContent=this.value+'%'">
        </div>
      </div>

      <div class="card">
        <h3>Online (optional)</h3>
        <div class="small muted">Firebase-Config eintragen für Raum/Code (Hook vorbereitet).</div>
        <textarea id="fbconf" rows="3" placeholder='{"apiKey":"...","authDomain":"...","databaseURL":"...","projectId":"...","storageBucket":"...","messagingSenderId":"...","appId":"..."}'></textarea>
        <div class="row">
          <button onclick="createRoom()">Raum erstellen</button>
          <input id="roomCodeIn" placeholder="Code eingeben">
          <button onclick="joinRoom()">Beitreten</button>
        </div>
        <div class="small muted" id="roomStatus">Kein Raum verbunden.</div>
      </div>
    </div>

    <div class="row" style="justify-content:center">
      <button class="primary big" onclick="startRound()">Runde starten</button>
    </div>
  </div>

  <!-- Reveal (Flip Card) -->
  <div id="screen-reveal" class="card" style="display:none">
    <h2 class="row" style="justify-content:space-between">
      <span>Geheime Enthüllung</span>
      <span class="pill" id="who-starts" title="Startspieler für Hinweise">Starter: –</span>
    </h2>
    <p class="muted">Gib das Gerät an <b id="rev-name">Name</b>. Tippe auf die Karte, um zu enthüllen.</p>
    <div class="flip-wrap">
      <div id="flipCard" class="flip-card" onclick="flip()">
        <div class="face front">
          <div style="text-align:center">
            <div class="title">Spieler:in</div>
            <div id="frontName" class="who">–</div>
            <div class="small muted" style="margin-top:8px">Tippen zum Anzeigen</div>
          </div>
        </div>
        <div class="face back">
          <div style="text-align:center">
            <div id="backMain" class="word">Wort</div>
            <div id="backRole" class="role">Rolle</div>
          </div>
        </div>
      </div>
    </div>
    <div class="row" style="justify-content:center">
      <button onclick="prevReveal()">Zurück</button>
      <button class="primary" onclick="nextReveal()">Weiter</button>
    </div>
  </div>

  <!-- Discuss -->
  <div id="screen-discuss" class="card" style="display:none">
    <h2>Hinweise & Diskussion <span class="pill" id="starter-pill"></span></h2>
    <div class="timer"><div id="tbar"></div></div>
    <div class="row" style="justify-content:center;margin-top:10px">
      <button class="primary" onclick="goVote()">Zur Abstimmung</button>
      <button onclick="pauseTimer()">Pause</button>
      <button onclick="resumeTimer()">Weiter</button>
    </div>
  </div>

  <!-- Vote -->
  <div id="screen-vote" class="card" style="display:none">
    <h2>Abstimmung</h2>
    <div id="vote-list"></div>
    <div class="row">
      <button onclick="revealResult()">Auswerten</button>
      <button onclick="toggleTie()">Stechen-Modus umschalten</button>
    </div>
  </div>

  <!-- Result -->
  <div id="screen-result" class="card" style="display:none">
    <h2 id="res-title">Ergebnis</h2>
    <p id="res-desc" class="muted"></p>
    <div class="row">
      <button class="primary" onclick="newWordSamePlayers()">Weiter – neues Wort</button>
      <button onclick="backToSetup()">Zurück zum Setup</button>
    </div>
  </div>
</div>

<script>
/* ======= Wortpools (gekürzt für Lesbarkeit; identisch wie zuvor) ======= */
const WORDS = {
  "WM / Fußball":[ "Elfmeter","Abseits","Freistoß","Ecke","Torwart","Verteidiger","Stürmer","Mittelfeld","Halbzeit","Nachspielzeit","Gelbe Karte","Rote Karte","VAR","Abwehrkette","Flanke","Konter","Dribbling","Pressing","Abstoß","Anstoß","Latte","Pfosten","Volley","Kopfball","Handspiel","Grätsche","Passspiel","Doppelpass","Offensivfoul","Rückpass","Auswechslung","Trikot","Schienbeinschoner","Trainerbank","Spielfeldrand","Anhang","Fangesang","Choreografie","Heimspiel","Auswärtsspiel","Derby","Spielplan","Gruppenphase","K.-o.-Runde","Achtelfinale","Viertelfinale","Halbfinale","Finale","Pokal","Weltmeister","Gastgeber","Nach Elfmetern" ],
  "Tiere":[ "Elefant","Tiger","Löwe","Giraffe","Nashorn","Zebra","Pinguin","Koala","Känguru","Panda","Delfin","Hai","Wal","Eule","Fuchs","Wolf","Bär","Leopard","Gepard","Nilpferd","Krokodil","Krake","Seestern","Qualle","Ameise","Biene","Libelle","Schmetterling","Marienkäfer","Erdmännchen","Dachs","Otter","Igel","Maulwurf","Fledermaus","Papagei","Flamingo","Pfau","Strauß","Alpaka","Lama","Yak","Rentier","Murmeltier","Marder","Waschbär","Elch","Vielfraß","Schakal","Warzenschwein" ],
  "Essen & Trinken":[ "Pizza","Burger","Sushi","Tacos","Falafel","Currywurst","Bratwurst","Sauerkraut","Käsespätzle","Lasagne","Carbonara","Ramen","Pho","Curry","Pad Thai","Paella","Hummus","Guacamole","Maultaschen","Döner","Burrito","Gyros","Hotdog","Onigiri","Gulasch","Fondue","Raclette","Pesto","Tiramisu","Baklava","Apfelstrudel","Schwarzwälder Kirschtorte","Kaiserschmarrn","Brezel","Käsekuchen","Quiche","Risotto","Tapas","Tortilla","Churros","Shakshuka","Kimchi","Bibimbap","Sauerteig","Latte Macchiato","Espresso","Cappuccino","Eistee","Limonade","Mate","Kombucha" ],
  "Städte & Orte":[ "Berlin","Hamburg","München","Köln","Frankfurt","Stuttgart","Dresden","Leipzig","Bremen","Hannover","Dortmund","Essen","Düsseldorf","Nürnberg","Heilbronn","St. Pauli","Sylt","Zugspitze","Schwarzwald","Rügen","Konstanz","Heidelberg","Tübingen","Freiburg","Aachen","Bamberg","Weimar","Potsdam","Krakau","Warschau","Danzig","Prag","Wien","Zürich","Genf","Paris","Lyon","London","Manchester","Madrid","Barcelona","Rom","Mailand","Venedig","Lissabon","Porto","New York","Los Angeles","Toronto","Mexiko-Stadt" ],
  "Alltagsdinge":[ "Schlüssel","Geldbeutel","Kopfhörer","Ladekabel","Powerbank","Regenschirm","Brille","Notizbuch","Kuli","Taschenmesser","Taschenlampe","Handcreme","Desinfektionsgel","Haargummi","USB-Stick","Rucksack","Trinkflasche","Brotdose","Kaugummi","Taschentücher","Fahrausweis","EC-Karte","Ausweis","Studentenausweis","Fitnessband","Smartwatch","Maus","Tastatur","Monitor","Adapter","Mehrfachsteckdose","Klebeband","Schere","Heftklammern","Büroklammer","Briefumschlag","Feuerzeug","Streichholz","Kerze","Luftpumpe","Fahrradschloss","Schloss","Gürtel","Mütze","Handschuh","Schal","Maske","Pflaster","Thermobecher","Kalender" ],
  "Berufe":[ "Ärztin/Arzt","Lehrkraft","Ingenieur:in","Programmierer:in","Architekt:in","Mechaniker:in","Elektriker:in","Bäcker:in","Konditor:in","Koch/Köchin","Kellner:in","Pilot:in","Flugbegleiter:in","Polizist:in","Feuerwehr","Sanitäter:in","Fotograf:in","Journalist:in","Designer:in","Produktmanager:in","Verkäufer:in","Apotheker:in","Chemiker:in","Physiker:in","Biolog:in","Gärtner:in","Schreiner:in","Installateur:in","Dachdecker:in","Maler:in","Friseur:in","Therapeut:in","Psycholog:in","Anwalt/Anwältin","Richter:in","Notar:in","Steuerberater:in","Zahnarzt/Zahnärztin","Tierarzt:Tierärztin","Hebamme","Logistiker:in","Lokführer:in","Busfahrer:in","Kurier:in","Data Scientist","Mechatroniker:in","Laborant:in","Übersetzer:in","Bibliothekar:in","Sozialarbeiter:in" ],
  "Marken & Technik":[ "Apple","Samsung","Google","Microsoft","Sony","Nintendo","PlayStation","Xbox","Tesla","BMW","Mercedes","Audi","Volkswagen","Porsche","Ikea","Zara","H&M","Adidas","Nike","Reebok","Asics","New Balance","Canon","Nikon","GoPro","DJI","Bose","Sennheiser","Beats","Dyson","Philips","Siemens","Bosch","Miele","Whirlpool","Ionos","AWS","Azure","Stackit","GitHub","Slack","Discord","WhatsApp","Instagram","TikTok","YouTube","Snapchat","Spotify","Netflix","Prime Video" ],
  "Filme & Serien (allg.)":[ "Star Wars","Herr der Ringe","Harry Potter","Game of Thrones","Breaking Bad","Stranger Things","The Dark Knight","Inception","Interstellar","Oppenheimer","Barbie","Forrest Gump","Gladiator","Titanic","Matrix","Avatar","Shrek","Toy Story","Cars","Coco","Der Pate","Fight Club","Pulp Fiction","The Boys","The Office","Friends","How I Met Your Mother","Sherlock","Lupin","Prison Break","Peaky Blinders","Vikings","Narcos","Black Mirror","Wednesday","Suits","Dune","Top Gun","Mission: Impossible","John Wick","Rocky","Creed","Jurassic Park","Frozen","Moana","Encanto","Inside Out","Wall·E","Up","Ratatouille" ],
  "Sport allgemein":[ "Tennis","Basketball","Handball","Volleyball","Leichtathletik","Schwimmen","Rudern","Segeln","Boxen","MMA","Ringen","Fechten","Turnen","Skispringen","Biathlon","Snowboard","Eishockey","Baseball","Cricket","Rugby","Badminton","Tischtennis","Radfahren","Triathlon","Marathon","Hürdenlauf","Speerwurf","Weitsprung","Kugelstoßen","Hochsprung","Diskus","Surfen","Klettern","Parkour","Skaten","Bouldern","Golf","Darts","Billard","Bowling","Reiten","Dressur","Polo","Kajak","Kanu","Motorsport","Formel 1","Rallye","Motocross","eSport" ],
  "Länder & Flaggen":[ "Deutschland","Frankreich","Italien","Spanien","Portugal","Niederlande","Belgien","Österreich","Schweiz","Polen","Tschechien","Slowakei","Ungarn","Dänemark","Schweden","Norwegen","Finnland","Island","Irland","Vereinigtes Königreich","USA","Kanada","Mexiko","Brasilien","Argentinien","Chile","Uruguay","Peru","Kolumbien","Venezuela","Japan","Südkorea","China","Indien","Thailand","Vietnam","Indonesien","Malaysia","Singapur","Philippinen","Ägypten","Marokko","Tunesien","Südafrika","Nigeria","Kenia","Äthiopien","Türkei","Saudi-Arabien","VAE" ],
  "Schule & Campus":[ "Whiteboard","Beamer","Tafel","Kreide","Schwamm","Lineal","Geodreieck","Zirkel","Taschenrechner","Block","Ordner","Heft","Mäppchen","Markierer","Textmarker","Korrekturroller","Collegeblock","Klausur","Referat","Hausarbeit","Seminar","Vorlesung","Tutorium","Mensa","Cafeteria","Bibliothek","Skript","Handout","Projektor","Stuhlreihe","Stundenplan","Pausengong","Sporthalle","Musikraum","Chemielabor","Reagenzglas","Bunsenbrenner","Pipette","Mikroskop","Waage","Notebook","Tablet","WLAN","Hotspot","Webcam","Headset","Aufnahme","Cloud","Drucker","Scanner" ],
  "Random Spaß":[ "Klebebart","Entenfüße","Bananenschale","Konfettikanone","Seifenblasen","Wasserpistole","Luftballon","Glitzer","Neonstift","Gaffer Tape","Quietsche-Ente","Kaugummiblase","Emoji-Kissen","Blinklicht","Katzenhaar","Pizzakarton","Sockenmonster","Keksdose","Popcornmaschine","Wackeldackel","Schneekugel","Zauberwürfel","Jo-Jo","Yo-Yo-Trick","Springseil","Hula-Hoop","Wasserkocher","Toaster","Mikrowelle","Backofen","Staubsauger","Hauspantoffel","Kapuzenpulli","Jogginghose","Sonnenbrille","Badeente","Magnet","Post-it","Stickeralbum","Klebepistole","Locher","Tacker","Klammeraffe","Flaschenöffner","Schlüsselband","USB-Hub","Lichtschwert","Keksstempel","Wäscheklammer","Geldkatze" ]
};
const CAT_KEYS = Object.keys(WORDS);

/* ======= UI-Build (Kategorien & k) ======= */
function buildCategoryChecklist(){
  const box = document.getElementById("cat-list"); box.innerHTML="";
  CAT_KEYS.forEach((k, idx)=>{
    const label=document.createElement("label");
    label.className="row"; label.style.alignItems="center"; label.style.gap="8px";
    label.style.border="1px solid #1f2937"; label.style.borderRadius="10px"; label.style.padding="8px";
    const cb=document.createElement("input"); cb.type="checkbox"; cb.value=k; cb.checked=idx<3;
    const span=document.createElement("span"); span.innerHTML=`<b>${k}</b>`;
    label.appendChild(cb); label.appendChild(span); box.appendChild(label);
  });
  const kSel=document.getElementById("kcount"); kSel.innerHTML="";
  for(let i=1;i<=CAT_KEYS.length;i++){
    const op=document.createElement("option"); op.value=i; op.textContent=i+(i>1?" Kategorien":" Kategorie");
    if(i===2) op.selected=true; kSel.appendChild(op);
  }
}
buildCategoryChecklist();

/* ======= State ======= */
let players=[]; let activeCats=[]; let roundWord=""; let impostors=[]; let revealIdx=0;
let votes={}; let timerInt=null; let timeLeft=0; let tieMode=false; let starter=null;

/* ======= Helpers ======= */
function $(id){return document.getElementById(id)}
function swap(scr){ ["screen-setup","screen-reveal","screen-discuss","screen-vote","screen-result"].forEach(s=>$(s).style.display="none"); $(scr).style.display="block"; }
function renderPlayers(){ const box=$("names"); box.innerHTML=""; players.forEach((p,i)=>{ const s=document.createElement("span"); s.className="name"; s.textContent=p; s.title="Zum Entfernen klicken"; s.onclick=()=>{players.splice(i,1);renderPlayers()}; box.appendChild(s); }); }
function addPlayer(){ const v=$("name-in").value.trim(); if(!v) return; if(players.includes(v)) return alert("Name existiert schon."); players.push(v); $("name-in").value=""; renderPlayers(); }
function quickFill(){ const pool=["Alex","Ben","Chi","Dana","Emil","Fay","Gio","Hila","Ivo","Jona","Kim","Luca","Mara","Niko","Oli","Pia","Quin","Ria","Sam","Tara"]; while(players.length<6){ const n=pool[Math.floor(Math.random()*pool.length)]; if(!players.includes(n)) players.push(n);} renderPlayers(); }
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }
function sample(arr){ return arr[Math.floor(Math.random()*arr.length)] }

/* ======= Kategorien wählen ======= */
function pickActiveCategories(k){
  const checked=[...document.querySelectorAll("#cat-list input[type=checkbox]:checked")].map(cb=>cb.value);
  let base = checked.length ? checked.slice() : CAT_KEYS.slice();
  const missing = Math.max(0, k - base.length);
  if(missing>0){ const rest=CAT_KEYS.filter(c=>!base.includes(c)); shuffle(rest); base=base.concat(rest.slice(0,missing)); }
  if(base.length>k){ shuffle(base); base=base.slice(0,k); }
  return base;
}

/* ======= Troll-Modus Effekte ======= */
function applyTroll(impostorIdxs){
  const on = document.getElementById('trollOn').checked;
  const chaos = parseInt(document.getElementById('chaos').value,10)/100;
  if(!on || Math.random() > chaos) return impostorIdxs;
  const n = players.length;
  const modes = ["ALL","NONE","EXTRA2","EXTRA3"];
  const m = sample(modes);
  if(m==="ALL")  return players.map((_,i)=>i);
  if(m==="NONE") return [];
  if(m==="EXTRA3"){ const want=Math.min(3,Math.max(1,n-1)); const pool=players.map((_,i)=>i); shuffle(pool); return pool.slice(0,want); }
  if(m==="EXTRA2"){ const want=Math.min(2,Math.max(1,n-1)); const pool=players.map((_,i)=>i); shuffle(pool); return pool.slice(0,want); }
  return impostorIdxs;
}

/* ======= Flip-Karte ======= */
function setFlipFront(name){
  document.getElementById('frontName').textContent = name||"–";
  document.getElementById('flipCard').classList.remove('flipped');
}
function setFlipBack(isImp, word){
  document.getElementById('backMain').textContent = isImp ? "IMPOSTOR – ???" : ("Wort: " + word);
  document.getElementById('backRole').textContent = isImp ? "Rolle: Impostor" : "Rolle: Crew";
}
function flip(){ document.getElementById('flipCard').classList.toggle('flipped'); }

/* ======= Round start ======= */
function startRound(){
  const k = parseInt($("kcount").value,10);
  const impBase = parseInt($("impc").value,10);
  if(players.length<3) return alert("Mindestens 3 Spieler:innen.");
  if(impBase>=players.length) return alert("Zu viele Impostors für die Personenzahl.");

  activeCats = pickActiveCategories(k);
  let union=[]; activeCats.forEach(c=>union=union.concat(WORDS[c]));
  roundWord = union[Math.floor(Math.random()*union.length)];

  let idxs=players.map((_,i)=>i); shuffle(idxs);
  impostors = idxs.slice(0,impBase);
  impostors = applyTroll(impostors);

  starter = sample(players);
  document.getElementById('who-starts').textContent = "Starter: " + starter;

  revealIdx=0; votes={}; tieMode=false;
  $("rev-name").textContent = players[0];
  setFlipFront(players[0]);
  setFlipBack(isImpostor(0), roundWord);
  swap("screen-reveal");
}
function isImpostor(i){ return impostors.includes(i) }

/* ======= Reveal Fortschritt ======= */
function nextReveal(){
  if(revealIdx<players.length-1){
    revealIdx++;
    const name = players[revealIdx];
    $("rev-name").textContent = name;
    setFlipFront(name);
    setFlipBack(isImpostor(revealIdx), roundWord);
  } else {
    beginDiscuss();
  }
}
function prevReveal(){
  if(revealIdx>0){
    revealIdx--;
    const name = players[revealIdx];
    $("rev-name").textContent = name;
    setFlipFront(name);
    setFlipBack(isImpostor(revealIdx), roundWord);
  }
}

/* ======= Diskussion / Timer ======= */
function beginDiscuss(){
  const dur=parseInt($("dur").value,10);
  document.getElementById('starter-pill').textContent = "Starter: " + starter;
  startTimer(dur);
  swap("screen-discuss");
}
function startTimer(seconds){
  stopTimer(); timeLeft=seconds; $("tbar").style.width="100%";
  timerInt=setInterval(()=>{
    timeLeft-=0.1;
    $("tbar").style.width=Math.max(0,(timeLeft/seconds))*100+"%";
    if(timeLeft<=0){ stopTimer(); goVote(); }
  },100);
}
function stopTimer(){ if(timerInt){ clearInterval(timerInt); timerInt=null; } }
function pauseTimer(){ stopTimer(); }
function resumeTimer(){ if(!timerInt){ startTimer(Math.max(1,Math.ceil(timeLeft))); } }

/* ======= Voting ======= */
function goVote(){
  stopTimer();
  const list=$("vote-list"); list.innerHTML="";
  players.forEach(p=>{ const b=document.createElement("button"); b.className="vote-btn"; b.textContent=p; b.onclick=()=>b.classList.toggle("sel"); list.appendChild(b); });
  swap("screen-vote");
}
function toggleTie(){ tieMode=!tieMode; alert(tieMode?"Stechen-Modus: wähle genau 1 Person.":"Normalmodus: Mehrere wählbar – Mehrheit entscheidet."); }
function revealResult(){
  const sels=[...document.querySelectorAll(".vote-btn.sel")].map(b=>b.textContent);
  if(tieMode && sels.length!==1) return alert("Stechen-Modus: genau EINE Person wählen.");
  if(sels.length===0) return alert("Niemand gewählt.");
  const counts={}; sels.forEach(n=>counts[n]=(counts[n]||0)+1);
  let top=[],max=0; for(const [n,c] of Object.entries(counts)){ if(c>max){max=c;top=[n]} else if(c===max){ top.push(n) } }
  const accused=sample(top);
  const hit = isImpostor(players.indexOf(accused));
  const imps = impostors.length?impostors.map(i=>players[i]).join(", "):"–";
  $("res-title").textContent = hit ? "Treffer!" : "Daneben!";
  $("res-desc").textContent = (hit?`Ihr habt ${accused} gewählt. Korrekt 🎯.`:`Ihr habt ${accused} gewählt – leider falsch.`) + `\nImpostor: ${imps}\nGeheimes Wort: „${roundWord}“.`;
  swap("screen-result");
}

/* ======= Next / Reset ======= */
function newWordSamePlayers(){ startRound(); }
function backToSetup(){ swap("screen-setup"); }

/* ======= Regeln ======= */
function showHelp(){
  alert(`Flip-Reveal:
– Karte zeigt vorne den Namen, Tippen flippt weich zur Rückseite (Wort/Rolle).
– „Weiter/Zurück“ schließt die Karte automatisch.
– Starter ist zufällig. Troll-Modus: Chaos-Effekte (alle/keine/extra Impostors).
– Optionaler Online-Hook über Firebase (Konfiguration erforderlich).`);
}

/* ======= Online-Hook (optional, minimal) ======= */
let NET = { mode:"local", room:null, me:null, db:null, app:null, code:null };
function parseConfig(){ try { return JSON.parse(document.getElementById('fbconf').value.trim()); } catch{ alert("Config ist kein gültiges JSON."); return null; } }
function setStatus(s){ document.getElementById('roomStatus').textContent = s; }
async function ensureFirebase(){ if(typeof window.firebase === "undefined"){ const s1=document.createElement('script'); s1.src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"; const s2=document.createElement('script'); s2.src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"; document.head.appendChild(s1); await new Promise(r=>s1.onload=r); document.head.appendChild(s2); await new Promise(r=>s2.onload=r); } }
function rndCode(){ return Math.floor(100000+Math.random()*900000).toString() }
async function createRoom(){ const conf=parseConfig(); if(!conf) return; await ensureFirebase(); try{ NET.app=firebase.initializeApp(conf);}catch(e){} NET.db=firebase.database(); NET.code=rndCode(); NET.room=NET.db.ref("whosus/"+NET.code); NET.me="Host-"+Math.random().toString(36).slice(2,6); await NET.room.set({phase:"lobby",players:{},config:{}}); await NET.room.child("players/"+NET.me).set({name:NET.me, ts:Date.now()}); NET.mode="firebase"; setStatus("Raum: "+NET.code+" (Host)."); }
async function joinRoom(){ const conf=parseConfig(); if(!conf) return; const code=document.getElementById('roomCodeIn').value.trim(); if(!code) return alert("Code eingeben."); await ensureFirebase(); try{ NET.app=firebase.initializeApp(conf);}catch(e){} NET.db=firebase.database(); NET.code=code; NET.room=NET.db.ref("whosus/"+NET.code); NET.me="P-"+Math.random().toString(36).slice(2,6); await NET.room.child("players/"+NET.me).set({name:NET.me, ts:Date.now()}); NET.mode="firebase"; setStatus("Beigetreten: "+NET.code+" als "+NET.me); NET.room.child("players").on("value", snap=>{ const val=snap.val()||{}; players=Object.values(val).map(v=>v.name); renderPlayers(); }); }
async function netBroadcastRound(word, impIdxs, startName){ if(NET.mode!=="firebase") return; const payload={word,impostors:impIdxs,starter:startName,ts:Date.now()}; await NET.room.child("round").set(payload); await NET.room.child("phase").set("reveal"); }
(function wireOnline(){ setInterval(()=>{ if(NET.mode==="firebase" && NET.room){ NET.room.child("round").once("value").then(s=>{ const r=s.val(); if(!r) return; if(roundWord!==r.word){ roundWord=r.word; impostors=r.impostors||[]; starter=r.starter||sample(players)||players[0]||null; revealIdx=0; votes={}; tieMode=false; document.getElementById('who-starts').textContent="Starter: "+starter; $("rev-name").textContent=players[0]||""; setFlipFront(players[0]); setFlipBack(isImpostor(0), roundWord); swap("screen-reveal"); } }); } },1200); })();
const _startRoundLocal = startRound;
startRound = async function(){ if(NET.mode==="firebase" && NET.code){ if(!players.length){ alert("Online-Lobby leer."); return; } const k=parseInt($("kcount").value,10); const impBase=parseInt($("impc").value,10); activeCats=pickActiveCategories(k); let union=[]; activeCats.forEach(c=>union=union.concat(WORDS[c])); const word=union[Math.floor(Math.random()*union.length)]; let idxs=players.map((_,i)=>i); shuffle(idxs); let imp=idxs.slice(0,Math.min(impBase,Math.max(1,players.length-1))); imp=applyTroll(imp); const startName=sample(players); await netBroadcastRound(word,imp,startName); setStatus("Runde gestartet (Broadcast)."); } else { _startRoundLocal(); } };
</script>
</body>
</html>